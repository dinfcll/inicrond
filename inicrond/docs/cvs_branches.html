<html><head><title>CVS Branch and Tag Primer</title></head>

<body>
<center>
<h2>CVS Branch and Tag Primer</h2>

<font size="-1">
Jeff Semke<br>
Pittsburgh Supercomputing Center<br>
4/21/98</font>
</center>
<p>

In attempting to construct a CVS repository containing multiple versions of
original NetBSD source distributions, as well as our own custom modifications
to each of these, I found that the CVS man page was vague and unclear.
</p><p>

This document assumes general familiarity with the CVS system, including the
concepts of modules, the repository, and basic checkout and commit operations.
</p><p>

Branches and tags are very different things, though they appear similar
on the outside.  Understanding the difference is the key to being able
to support a multi-branched repository that can change as our custom code
is modified for all versions of NetBSD.
</p><p>

The main concepts that are addressed in this document are:
</p><dl>
     <dt>Tree structure
     </dt><dd>Code in a CVS repository can be thought of as a tree.  The tree shape
     is not based on the directory structure of the code, but rather on the
     versions of the code.

     </dd><dt>Trunk
     </dt><dd>As code gets modified and is committed back to the repository, it
     adds another revision to extend the tree.  If no branches are specified
     when checking out working directories, the tree simply grows in a line
     along the main trunk of the tree.

     </dd><dt>Tags
     </dt><dd>A tag can be used to name a particular revision of the code.  This
     tag can later be used to compare different revisions, to go back to an
     earlier version, or to specify a place to create a branch.

     </dd><dt>Branches
     </dt><dd>Branches allow different development paths to be tried.  They can
     be created from the main trunk, or from other branches.  
</dd></dl>


<h3>1. The trunk of the tree</h3>

<ul>
     As the code gets modified, each revision extends the trunk of the tree.
     The trunk itself is named only by the module name, not by tags or
     branches.  You can get a copy of the latest revision of the main trunk 
     to work on with the command
     <ul>
          <tt>cvs checkout <i>my_module</i></tt>
     </ul>
     <p>

     This creates a working directory called <i>my_module</i>, and it contains
     the files and subdirectories of <i>my_module</i>.  After you make your
     changes, you enter them into a new revision on the main trunk with the
     command<br>
     </p><ul>
          <tt>cvs commit</tt>
     </ul>
</ul>

<h3>2. Branches</h3>

<ul>
     <h4>2.1 Creating a Branch</h4>
 
     Branches can be added to the repository tree in order to allow different
     development paths to be tried, or to add parallel development of code
     to different base versions.  To create a branch, you can use
     <ul>
          <tt>cvs tag</tt>
     </ul>
     or
     <ul>
          <tt>cvs rtag</tt>
     </ul>
     with the <tt>-b</tt> option.  
     <p>

     <strong>Do not be fooled! Even though the same commands can be
     used to create <a href="#tag">tags</a>, branches are completely
     different than tags.</strong> 
     </p><p>

     </p><ul>     
          <h4>2.1.1 rtag</h4>

          To create a branch from the main trunk of <i>my_module</i> at the 
          revision that was last committed, use the command
          <ul>
               <tt>cvs rtag -b <i>Branchname my_module</i></tt>
          </ul>
          <p>

          To create a branch from a tagged revision of <i>my_module</i>,
          use the command
          </p><ul>
               <tt>cvs rtag -r <i>Tagname</i> -b <i>Branchname my_module</i>
               </tt>
          </ul>
          <p>

          Both commands immediately create a branch in the repository
          <strong>without</strong> requiring a <tt>cvs commit</tt> to
          enact.  You do not need to be in a checked-out working directory
          to do this.

          </p><h4>2.1.2 tag</h4>

          If you are in a working directory, you can create a new branch
          <strong>in the branch or trunk from which you checked out your
          working directory (not including the changes you've made to
          your working directory since the last commit)</strong> by using the 
          command
          <ul>
               <tt>cvs tag -b <i>Branchname</i></tt>
          </ul>
          <p>

          Like <tt>rtag</tt>, the change is immediate, and does not wait for 
          a <tt>commit</tt> command.  </p><p>
     
          Your working directory remains on the old branch, at a point after
          the branch you just created.  To move your working directory to the 
          new branch, use the command
          </p><ul>
               <tt>cvs update -r <i>Branchname</i></tt>
          </ul>
          When you are finished making changes to your working directory, save
          it as the next revision on the new branch with
          <ul>
               <tt>cvs commit</tt>
          </ul>
     
          <h4>2.1.3 Both rtag and tag</h4>
     
          <strong>Note that</strong> both <tt>rtag</tt> and <tt>tag</tt> work
          directly on the repository and take effect immediately without a
          <tt>commit</tt> command.  <tt>Rtag</tt> takes effect at the specified
          place (the end of the main trunk by default), while <tt>tag</tt>
          takes effect at the place where the working directory was checked 
          out or last committed.
     </ul>

     <h4>2.2 Checking Out a Branch to Work On</h4>
     <ul>
          To check out the latest revision of a branch to work on, use the
          command
          <ul>
               <tt>cvs checkout -r <i>Branchname my_module</i></tt>
          </ul>
          When you do a <tt>cvs commit</tt>, the changes are merged in on
          the branch from which they were checked out.
     </ul>

     <h4>2.3 General</h4>
     <ul>
          Note that branch names refer to the latest revision of the branch
          they are on, not the state they were in when the branch was
          created.
     </ul>
</ul>

<a name="tag">
<h3>3. Tags</h3></a>

<ul>
     A tag provides a means to name a certain revision of the code, or
     take a "snapshot" of it at a certain point in time.  This tag
     only applies a named handle to the code at that point in time, it
     does not create a new branch of code.
     <h4>3.1 Creating a Tag</h4>
     <ul>
          In order to name the current end of the main trunk of a module,
          use the command
          <ul>
               <tt>cvs rtag <i>Tagname my_module</i></tt>
          </ul>
          In order to name the current end of a branch of a module, use 
          the command
          <ul>
               <tt>cvs rtag -r <i>Branchname Tagname my_module</i></tt>
          </ul>
          <p>

          Otherwise, to name the code that your working directory was
          checked out from (<strong>without the changes you made to your
          working directory since the last commit</strong>), use the command
          </p><ul>
               <tt>cvs tag <i>Tagname</i></tt>
          </ul>
     </ul>

     <h4>3.2 Using a Tagged version of code</h4>
     <ul>
          You can check out tagged versions of code with the command
          <ul>
               <tt>cvs checkout -r <i>Tagname my_module</i></tt>
          </ul>
          <p>

          This creates a working directory with the code as it was when the
          tag was created.  While branch names refer to the latest code at
          the end of a branch (and as such, are dynamic), tag names refer 
          to the static version of code that existed upon the tag's creation.
          As a result, you cannot commit changes back into the tree at the
          tagged place that you checked them out from.
          </p><p>

          If desired, a new branch can be created at the place the tag
          was applied, then changes can be committed into the new branch as
          follows:
          </p><ul>
               <tt>cvs rtag -r <i>Tagname NewBranchname my_module</i><br>
               cvs update -r <i>NewBranchname</i></tt><br>
               Finish changes to the working directory, then<br>
               <tt>cvs commit</tt>
          </ul>
          <p>

          To access this version of the code again later (along with any 
          changes that were made by others since you last accessed it), use
          </p><ul>
               <tt>cvs checkout -r <i>NewBranchname my_module</i></tt>
          </ul>
     </ul>
</ul>

<h3>4. Merging branches</h3>
<ul>
     <h4>4.1 Using Update</h4>

     <tt>cvs update -j <i>TagOrBranch1</i> -j <i>TagOrBranch2 my_module</i>
     </tt>
     <p>

     The above command will locate the differences between <i>TagOrBranch1</i>
     and <i>TagOrBranch2</i>.  Of the lines that are different between them,
     the lines in <i>TagOrBranch2</i> will be patched, or merged, into the 
     sources in your working directory.
     </p><p>

     An annoying problem that I have not yet solved is that new files that
     appear in <i>TagOrBranch2</i> but not in <i>TagOrBranch1</i> do not
     get created by the merge.  The only thing I know of to get these files
     into the new version is to checkout <i>TagOrBranch2</i>, copy the files
     into the merged working directory, and do
     </p><ul>
          <tt>cvs add <i>filename</i></tt>
     </ul>

     <h4>4.2 Using Checkout</h4>

     <tt>cvs checkout -j <i>TagOrBranch1</i> -j <i>TagOrBranch2 my_module</i>
     </tt>
     <p>

     The above command will locate the differences between <i>TagOrBranch1</i>
     and <i>TagOrBranch2</i>.  Of the lines that are different between them,
     the lines in <i>TagOrBranch2</i> will be patched, or merged, into the 
     latest revision on the main trunk of <i>my_module</i>.
     </p><p>

     In order to have these differences merged into a different branch, and
     then have that branch checked out, use
     </p><ul>
          <tt>cvs checkout -r <i>BranchToMergeTo</i> -j <i>TagOrBranch1</i> 
          -j <i>TagOrBranch2 my_module</i></tt>
     </ul>
     <p>

     Like <tt>update</tt>, file that were created between <i>TagOrBranch1</i>
     and <i>TagOrBranch2</i> do not get created automatically.
</p></ul></body></html>